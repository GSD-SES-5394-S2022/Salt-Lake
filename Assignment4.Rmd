---
title: "Assignment 4"
author: "Charuvi Begwani, Aijing Li"
date: "2/17/2022"
output: html_document
---

#Networks - Existing Scenario
This file determines the existing characteristics of the street and transit networks within Salt Lake MSA.



#Load relevant libraries
```{r, message=FALSE, warning=FALSE}

options(java.parameters = "-Xmx2G")

library(tidyverse)
library(sf)
library(tigris)
library(osmdata)
library(devtools)
library(tidytransit)
library(here)
library(r5r)
library(lubridate)
library(scenRios)
library(knitr)
library(ggthemes)
library(RColorBrewer)


```


#Download a GTFS feed
We downloaded data on Utah Transit Authority in the GTFS format from OpenMobilityData which maintains an archive of GTFS feeds for cities throughout the world. We downloaded the GTFS feed dated 15 February 2022 for our study area from here (https://transitfeeds.com/p/utah-transportation-authority) and saved the zipped file to the networks subfolder in the existing folder of our project directory. 

#Download an OpenStreetMap network
We represent the existing roadway network in a format that to allow us to calculate travel times. OpenStreetMaps is helpful for this.
```{r}
# Load the MSA boundaries
boundary <- core_based_statistical_areas() %>%
  filter(GEOID == "41620")

# Define a bounding box containing the MSA
saltlake_bbox <- st_bbox(boundary)

q <- opq(bbox = saltlake_bbox) %>% # create a query
  add_osm_feature(key = 'highway') %>% # request only road data
  osmdata_xml(file = 'existing/networks/streets.osm') # download osm file
```


#Convert an OSM file to a PBF file
You will be downloading OpenStreetMap data (and potentially editing it) in the .osm file format. To use it with the the the r5r package, youâ€™ll need to convert it to a .pbf file (which is just a compressed version of the *.osm file).

#Create zone centroids
To be able to calculate the travel times to and from each centroid, we generate a set of centroid points from the zone boundary. Then, we write the centroids into original zones dataset.
```{r}
centroids <- here("zones",
                  "boundaries.geojson") %>%
  st_read() %>%
  st_centroid() %>%
  st_transform("WGS84") %>%
  rename(id = GEOID)
```
```{r}
# save centroids to original zones dataset
st_write(centroids, here("zones", "centroids.geojson"))
```



#Generate skims(Existing Scenario)
In the chunks below, we generate skim for existing scenario in the studied area with the R5R package.


```{r}
existing_core <- here("existing",
                      "networks") %>%
  setup_r5(verbose = FALSE)
```

```{r, message = FALSE, warning=FALSE, include= FALSE}
#generate car skims
car_skim_exs <- travel_time_matrix(existing_core, 
                     origins = centroids,
                     destinations = centroids,
                     mode = "CAR")
```

```{r, include = FALSE}
#generate bike skims
bicycle_skim_exs <- travel_time_matrix(existing_core, 
                     origins = centroids,
                     destinations = centroids,
                     mode = "BICYCLE")
```

```{r,include = FALSE}
#generate walk skims
walk_skim_exs <- travel_time_matrix(existing_core, 
                     origins = centroids,
                     destinations = centroids,
                     mode = "WALK")
```

```{r, message=FALSE,warning=FALSE, echo=FALSE, include = FALSE}
#generate transit skims

transit_skim_exs <- travel_time_matrix(existing_core, 
                     origins = centroids,
                     destinations = centroids,
                     mode = "TRANSIT",
                     departure_datetime = ymd_hm("2022-03-09 17:00"),
                     breakdown = TRUE)
```

```{r}
stop_r5()
```

```{r}
# clean empty entries in transit skim
transit_skim_exs <- transit_skim_exs %>%
  filter(n_rides > 0)
```

```{r}
#combine all skims into one file
car_skim_exs <- car_skim_exs %>%
  rename(car_time = travel_time)

transit_skim_exs <- transit_skim_exs %>%
  rename(transit_time = travel_time)

walk_skim_exs <- walk_skim_exs %>%
  rename(walk_time = travel_time)

bicycle_skim_exs <- bicycle_skim_exs %>%
  rename(bike_time = travel_time)

all_skims_exs <- full_join(transit_skim_exs, car_skim_exs) %>%
  full_join(walk_skim_exs)%>%
  full_join(bicycle_skim_exs)

write_csv(all_skims_exs, here("existing/data/skims.csv"))
```


## Modify Transportation Network for Alternative Scenario
# View GTFS service plans


```{r}
current_gtfs <- here("existing",
                     "networks",
                     "gtfs.zip") %>%
  read_gtfs()
```

# Read existing transit route frequency
```{r}
current_hdwys <- gtfs_get_hdwys(current_gtfs, 
                                        route = "27610",
                                        service = "4")
kable(current_hdwys)
```
# Edit frequency/headway
The original frequency is not even, ranging from around 14-30 minutes. The code below set a new minimum headway to 5 minutes.
```{r}
new_gtfs <- gtfs_set_min_hdwy(current_gtfs,
                              route = "27610",
                              service = "4",
                              new_hdwy = 5)
```

#check results 
The new headway ranges from 5-15 minutes, which is roughly twice of the original frequency and satisfies the purpose of the study.
```{r}
new_hdwys <- gtfs_get_hdwys(new_gtfs,
                            route = "27610",
                            service = "4")


kable(new_hdwys)
```
# Save the new GTFS file
```{r}
new_gtfs_path <- here("alternative",
                      "networks",
                      "gtfs.zip")

write_gtfs(new_gtfs, new_gtfs_path)
```



#Prepare to edit openstreet map
```{r}
library(scenRios)
library(tidyverse)

old_network <- read_lines("existing/networks/streets.osm")


new_network <- osm_prep_network(old_network)

write_lines(new_network, 
            file = "alternative/networks/streets.osm")
```



#Generate skims(Alternative Scenario)
In the chunks below, we generate skim for alternative scenario in the studied area with the R5R package.


```{r}
alternative_core <- here("alternative",
                      "networks") %>%
  setup_r5(verbose = FALSE)
```

```{r, message = FALSE, warning=FALSE, include= FALSE}
#generate car skims
car_skim_alt <- travel_time_matrix(alternative_core, 
                     origins = centroids,
                     destinations = centroids,
                     mode = "CAR")
```

```{r, include = FALSE}
#generate bike skims
bicycle_skim_alt <- travel_time_matrix(alternative_core, 
                     origins = centroids,
                     destinations = centroids,
                     mode = "BICYCLE")
```

```{r,include = FALSE}
#generate walk skims
walk_skim_alt <- travel_time_matrix(alternative_core, 
                     origins = centroids,
                     destinations = centroids,
                     mode = "WALK")
```

```{r, message=FALSE,warning=FALSE, echo=FALSE, include = FALSE}
#generate transit skims

transit_skim_alt <- travel_time_matrix(alternative_core, 
                     origins = centroids,
                     destinations = centroids,
                     mode = "TRANSIT",
                     departure_datetime = ymd_hm("2022-03-09 17:00"),
                     breakdown = TRUE)
```

```{r}
stop_r5()

```

```{r}
# clean empty entries in transit skim
transit_skim_alt <- transit_skim_alt %>%
  filter(n_rides > 0)
```

```{r}
#combine all skims into one file
car_skim_alt <- car_skim_alt %>%
  rename(car_time = travel_time)

transit_skim_alt <- transit_skim_alt %>%
  rename(transit_time = travel_time)

walk_skim_alt <- walk_skim_alt %>%
  rename(walk_time = travel_time)

bicycle_skim_alt <- bicycle_skim_alt %>%
  rename(bike_time = travel_time)

all_skims_alt <- full_join(transit_skim_alt, car_skim_alt) %>%
  full_join(walk_skim_alt)%>%
  full_join(bicycle_skim_alt)

write_csv(all_skims_alt, here("alternative/data/skims.csv"))
```

```{r}
all_skims_exs <- read.csv("existing/data/skims.csv")
```

```{r}
table <- all_skims_exs %>%
  pivot_longer(cols=c(walk_time,car_time,transit_time,bike_time),
               names_to = "Variable",
               values_to = "value") %>%
  group_by(Variable) %>%
  summarize(Average = mean(value, na.rm=TRUE),
            `Standard deviation` = sd(value, na.rm=TRUE),
            Median = median(value, median(value, na.rm=TRUE)))

```

```{r}

map_palette <- brewer.pal(5, "YlOrBr")

map_existing <- ggplot(zones) +
  geom_sf(aes(fill = existing),
          color = NA) +
  geom_sf(data = zones[zones$GEOID=="36029002502",],
          fill = "blue",
          color = "blue") +
  scale_fill_gradientn(colours = map_palette,
                       name = "Travel time\n(existing)") +
  theme_void()

map_existing
```

