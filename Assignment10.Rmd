---
title: "Assignment 10"
author: "Charuvi Begwani, Aijing Li"
date: "4/11/2022"
output: html_document
---

#Load libraries

```{r}
options(java.parameters = "-Xmx2G")

library(here)
library(tidyverse)
library(stplanr)
library(r5r)
library(sf)
library(tidyverse)
```

#Load data from previous assignments including production and attraction zone IDs, the transit routes included in that transit trip, and the number of trips by each mode for each trip purpose.

```{r}
skims <- here("existing",
                     "data",
                     "skims.csv") %>%
  read_csv(show_col_types = FALSE) %>%
  select(fromId, 
         toId, 
         n_transit_HBO,
         n_SOV_HBO,
         n_HOV_HBO,
         n_walk_HBO,
         n_bike_HBO,
         n_transit_HBW,
         n_SOV_HBW,
         n_HOV_HBW,
         n_walk_HBW,
         n_bike_HBW,
         n_transit_NHB,
         n_SOV_NHB,
         n_HOV_NHB,
         n_walk_NHB,
         n_bike_NHB,
         routes) %>%
  mutate(fromId = as.character(fromId),
         toId = as.character(toId))
```

#Convert P-A matrix to O-D matrix: HBO Trips

##Convert data frame to matrix
```{r}
HBO_PA_mat <- skims %>%
  od_to_odmatrix(attrib = "n_transit_HBO", 
                 name_orig = "fromId",
                 name_dest = "toId") 

HBO_PA_mat <- HBO_PA_mat[,row.names(HBO_PA_mat)]
```

##Transpose trip matrix
```{r}
HBO_PA_mat_trans <- t(HBO_PA_mat)
```

##Average matrix with its transpose 
```{r}
HBO_OD_mat <- (HBO_PA_mat + HBO_PA_mat_trans) / 2
```

##Convert matrix to data frame
```{r}
HBO_OD_table <- HBO_OD_mat %>%
  odmatrix_to_od() %>%
  rename(fromId = orig,
         toId = dest) %>%
  left_join(skims) %>%
  select(-n_transit_HBO)
```
#Convert P-A matrix to O-D matrix: HBW Trips

```{r}
##Convert data frame to matrix
HBW_PA_mat <- skims %>%
  od_to_odmatrix(attrib = "n_transit_HBW", 
                 name_orig = "fromId",
                 name_dest = "toId") 

HBW_PA_mat <- HBW_PA_mat[,row.names(HBW_PA_mat)]

##Transpose trip matrix
HBW_PA_mat_trans <- t(HBW_PA_mat)

##Average matrix with its transpose and convert matrix to data frame
HBW_OD_mat <- (HBW_PA_mat + HBW_PA_mat_trans) / 2

HBW_OD_table <- HBW_OD_mat %>%
  odmatrix_to_od() %>%
  rename(fromId = orig,
         toId = dest) %>%
  left_join(skims) %>%
  select(-n_transit_HBW)

```
#Convert P-A matrix to O-D matrix: NHB Trips

```{r}
##Convert data frame to matrix
NHB_PA_mat <- skims %>%
  od_to_odmatrix(attrib = "n_transit_NHB", 
                 name_orig = "fromId",
                 name_dest = "toId") 

NHB_PA_mat <- NHB_PA_mat[,row.names(NHB_PA_mat)]

##Transpose trip matrix
NHB_PA_mat_trans <- t(NHB_PA_mat)

##Average matrix with its transpose and convert matrix to data frame
NHB_OD_mat <- (NHB_PA_mat + NHB_PA_mat_trans) / 2

NHB_OD_table <- NHB_OD_mat %>%
  odmatrix_to_od() %>%
  rename(fromId = orig,
         toId = dest) %>%
  left_join(skims) %>%
  select(-n_transit_NHB)

```

#Count trips using each route
```{r}
route_trips_HBO <- HBO_OD_table %>%
  filter(flow > 0 & !is.na(routes)) %>%
  mutate(route_1 = str_split_fixed(routes, "\\|", 3)[,1],
         route_2 = str_split_fixed(routes, "\\|", 3)[,2],
         route_3 = str_split_fixed(routes, "\\|", 3)[,3]) %>%
  pivot_longer(cols = c(route_1, route_2, route_3),
               values_to = "route") %>%
  filter(route != "") %>%
  select(route, flow) %>%
  group_by(route) %>%
  summarize(ridership = round(sum(flow)))

route_trips_HBW <- HBW_OD_table %>%
  filter(flow > 0 & !is.na(routes)) %>%
  mutate(route_1 = str_split_fixed(routes, "\\|", 3)[,1],
         route_2 = str_split_fixed(routes, "\\|", 3)[,2],
         route_3 = str_split_fixed(routes, "\\|", 3)[,3]) %>%
  pivot_longer(cols = c(route_1, route_2, route_3),
               values_to = "route") %>%
  filter(route != "") %>%
  select(route, flow) %>%
  group_by(route) %>%
  summarize(ridership = round(sum(flow)))

route_trips_NHB <- NHB_OD_table %>%
  filter(flow > 0 & !is.na(routes)) %>%
  mutate(route_1 = str_split_fixed(routes, "\\|", 3)[,1],
         route_2 = str_split_fixed(routes, "\\|", 3)[,2],
         route_3 = str_split_fixed(routes, "\\|", 3)[,3]) %>%
  pivot_longer(cols = c(route_1, route_2, route_3),
               values_to = "route") %>%
  filter(route != "") %>%
  select(route, flow) %>%
  group_by(route) %>%
  summarize(ridership = round(sum(flow)))

```

#Find VMT and PMT by mode
##Calculate trip distances

```{r}
centroids <- here("zones",
                   "centroids.geojson") %>%
  st_read() %>%
  rename(GEOID = id) %>%
  filter(!st_is_empty(.))

origins <- centroids %>%
  slice(rep(1:n(), each = n())) %>%
  mutate(dest_order =
           rep(seq(1:length(centroids$id)),
               length(centroids$id)))

destinations <- origins %>%
  arrange(dest_order)

r5r_core_existing <- here("existing",
                          "networks") %>%
  setup_r5(verbose = FALSE)

ped_dist <- detailed_itineraries(r5r_core_existing,
                                 origins = origins,
                                 destinations = destinations,
                                 mode = "WALK",
                                 verbose = FALSE)  %>%
  mutate(miles = distance / 1609.34) %>%
  select(fromId, toId, miles) %>%
  st_drop_geometry()

drive_dist <- detailed_itineraries(r5r_core_existing,
                                 origins = origins,
                                 destinations = destinations,
                                 mode = "CAR",
                                 verbose = FALSE) %>%
  mutate(miles = distance / 1609.34) %>%
  select(fromId, toId, miles) %>%
  st_drop_geometry()

bike_dist <- detailed_itineraries(r5r_core_existing,
                                 origins = origins,
                                 destinations = destinations,
                                 mode = "BICYCLE",
                                 verbose = FALSE) %>%
  mutate(miles = distance / 1609.34) %>%
  select(fromId, toId, miles) %>%
  st_drop_geometry()

stop_r5()
```

